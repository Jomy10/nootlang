package main

import (
	"fmt"
	"os"

	"github.com/jomy10/nootlang/interpreter"
	"github.com/jomy10/nootlang/parser"
)

func main() {
	fileData, err := os.ReadFile(os.Args[1])
	if err != nil {
		panic(fmt.Sprintf("Couldn't read source file %s\n", err.Error()))
	}

	// fmt.Println(string(fileData))

	tokens, err := parser.Tokenize(string(fileData))
	if err != nil {
		panic(err)
	}

	// fmt.Println("tokens", tokens)

	nodes, err := parser.Parse(tokens)
	if err != nil {
		panic(err)
	}

	// fmt.Println(nodes)

	stdout := make(chan string)
	stderr := make(chan string)
	eop := make(chan int, 1)

	defer close(stdout)
	defer close(stderr)
	defer close(eop)

	go interpreter.Interpret(nodes, stdout, stderr, eop)
	handleChannels(stdout, stderr, eop)
}

func handleChannels(stdout, stderr chan string, eop chan int) {
	for {
		select {
		case o := <-stdout:
			fmt.Println(o)
		case e := <-stderr:
			fmt.Fprintln(os.Stderr, e)
		case exitCode := <-eop:
			fmt.Printf("Program exited with exit code %d\n", exitCode)
			return
		}
	}
}

func printStdout(stdout chan string) {

	fmt.Println(<-stdout)
}

func printStderr(stderr chan string) {
	fmt.Fprintln(os.Stderr, <-stderr)
}
